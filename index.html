<!DOCTYPE html>
<html>
<head>
	<title>OhMyCookie</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel="stylesheet" href="css/main.css">

	<style type="text/css">
		*{
			margin: 0;
		}
		#paper{
			border: 1px solid black;
		}
	</style>

	<script type = "text/javascript" src = "https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>

<body>
	<canvas id="paper" width="0" height="0"></canvas>

	<button type="button" class="btn btn-primary" onclick="init()">init</button>
	<button type="button" class="btn btn-primary" onclick="send()">send</button>
	<button type="button" class="btn btn-primary" onclick="load()">load</button>
	<button type="button" class="btn btn-primary" onclick="beginGuessing()">beginGuessing</button>
	<button type="button" class="btn btn-primary" onclick="beginGuessingMouse()">beginGuessingMouse</button>
	<button type="button" class="btn btn-primary" onclick="beginDrawing()">beginDrawing</button>
	<button type="button" class="btn btn-primary" onclick="beginDrawingMouse()">beginDrawingMouse</button>
	<button type="button" class="btn btn-primary" onclick="stopLoop()">stop</button>

	<script type="text/javascript">	
		var c = document.getElementById("paper");
		var ctx = c.getContext("2d");
		var x0 = 0;
		var y0 = 0;
		var x1 = 0;
		var y1 = 0;
		var canDraw = true;
		

		// Begin
		init();	

		// Drawing functions
		$( "#paper" ).mousemove(function( event ) {
			if(canDraw)
			{
				x0 = x1;
				y0 = y1;
				x1 = event.pageX;
				y1 = event.pageY;
				if(isClicking)
				{
					draw();
				}
			}
		});

		function draw(){
			ctx.moveTo(x0, y0);
			ctx.lineTo(x1, y1);
			ctx.stroke();
		}

		// Check if the mouse is dragging / clicking / mousedown
		var isClicking = false;
		$( "#paper" ).mousedown(function(){
			isClicking = true;
		})
		.mouseup(function(){
		    isClicking = false;
		});

		// Resize paper
		function init(){
			var width = $(window).width() - 27;
			var height = $(window).height() - 27;

			// Always 16:9 aspect ratio
			if((width / (16/9)) < height)
			{
				c.width = width;
				c.height = width / (16/9);
			}
			else
			{
				c.width = height / (9/16);
				c.height = height;
			}
			clear();
			console.log("Paper initialised to " + c.width + "*" + c.height)
		}

		function clear(){
			ctx.clearRect(0, 0, c.width, c.height);
			c.width = c.width;
			return(null)
		}

		function beginGuessingMouse(){
			endLoop = false;
			canDraw = false;
			setTimeout(function(){
				getMouse();    
				draw();
				if (!endLoop) beginGuessingMouse()
			}, loopSpeed)
		}

		function beginDrawingMouse(){
			endLoop = false;
			canDraw = true;
			setTimeout(function(){
				sendMouse();
				if (!endLoop) beginDrawingMouse()
			}, loopSpeed)
		}

		function sendMouse(){
			var preX = x0 / c.width;
			var preY = y0 / c.height;
			var posX = x1 / c.width;
			var posY = y1 / c.height;
			$.post(
				"receive_mouse.php",
				{
					old_x: preX,
					old_y: preY,
					mouse_x: posX,
					mouse_y: posY	
				},
				function(data, status){

				}			
			)
		}

		function getMouse(){
			$.post(
				"send_mouse.php",
				{

				},
				function(data, status){
					var mouseLocation = data.split(',');
					x0 = mouseLocation[0] * c.width;
					y0 = mouseLocation[1] * c.height;
					x1 = mouseLocation[2] * c.width;
					y1 = mouseLocation[3] * c.height;
					console.log(data);
				}			
			)
		}

		function send(){
			var image = c.toDataURL("image/png");
			$.post(
				"upload_data.php",
				{
					hidden_data: image	
				},
				function(data, status){
					console.log("Image sent");
				}				
			)
		}

		function load(){
			$.post(
				"load_img.php",
				{
					hidden_data: "yerd"	
				},
				function(data, status){
					var imgToLoad = new Image();
					imgToLoad.onload = function(){
						clear();
						ctx.drawImage(this, 0, 0, c.width, c.height);
						console.log("Image loaded");
					}
					imgToLoad.src = data;
				}			
			)
		}

		var endLoop = false;
		var loopSpeed = 100;

		// Used for when people are guessing (loads entire image)
		function beginGuessing(){
			endLoop = false;
			canDraw = false;
			setTimeout(function(){
				load();    
				if (!endLoop) beginGuessing()
			}, loopSpeed)
		}

		// Used for when the person is drawing (sends entire image)
		function beginDrawing(){
			canDraw = true;
			endLoop = false;
			setTimeout(function(){
				send();    
				if (!endLoop) beginDrawing()
			}, loopSpeed)
		}

		function stopLoop(){
			endLoop = true;
		}
	</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
</body>
</html>
